<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆªå›¾åŒºåŸŸé€‰æ‹©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: rgba(0, 0, 0, 0.3);
            cursor: crosshair;
            overflow: hidden;
            user-select: none;
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        .selection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .selection-box {
            position: absolute;
            border: 2px solid #3498db;
            background: rgba(52, 152, 219, 0.1);
            pointer-events: none;
            display: none;
        }
        
        .selection-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            display: none;
        }
        
        .instructions {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            text-align: center;
            z-index: 1002;
            animation: fadeIn 0.3s ease;
        }
        
        .instructions-text {
            margin-bottom: 8px;
        }
        
        .instructions-shortcuts {
            font-size: 11px;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .cancel-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            z-index: 1002;
            transition: all 0.2s ease;
        }
        
        .cancel-btn:hover {
            background: rgba(231, 76, 60, 1);
            transform: translateY(-1px);
        }
        
        .fullscreen-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            z-index: 1002;
            transition: all 0.2s ease;
        }
        
        .fullscreen-btn:hover {
            background: rgba(52, 152, 219, 1);
            transform: translateX(-50%) translateY(-2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .corner-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3498db;
            border: 1px solid white;
            pointer-events: none;
            z-index: 1001;
        }
        
        .corner-handle.top-left {
            top: -4px;
            left: -4px;
        }
        
        .corner-handle.top-right {
            top: -4px;
            right: -4px;
        }
        
        .corner-handle.bottom-left {
            bottom: -4px;
            left: -4px;
        }
        
        .corner-handle.bottom-right {
            bottom: -4px;
            right: -4px;
        }

        /* é€‰æ‹©åŒºåŸŸæ§åˆ¶æŒ‰é’® */
        .selection-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .confirm-btn, .adjust-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .confirm-btn {
            background: #10b981;
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .confirm-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .adjust-btn {
            background: #6b7280;
            color: white;
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .adjust-btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="instructions" id="instructions">
        <div class="instructions-text">æ‹–æ‹½é€‰æ‹©æˆªå›¾åŒºåŸŸ</div>
        <div class="instructions-shortcuts">
            æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–æ‹½é€‰æ‹©åŒºåŸŸ â€¢ æŒ‰ä½ Shift æ¾å¼€å¯ç»§ç»­è°ƒæ•´ â€¢ ESC å–æ¶ˆ â€¢ Enter å…¨å±æˆªå›¾
        </div>
    </div>

    <!-- å›ºå®šæŒ‰é’® -->
    <button class="cancel-btn" id="cancelBtn">âœ• å–æ¶ˆ</button>
    <button class="fullscreen-btn" id="fullscreenBtn">ğŸ“· å…¨å±æˆªå›¾</button>

    <!-- é€‰æ‹©åŒºåŸŸç¡®è®¤æŒ‰é’® (åˆå§‹éšè—) -->
    <div class="selection-controls" id="selectionControls" style="display: none;">
        <button class="confirm-btn" id="confirmBtn">âœ“ ç¡®è®¤æˆªå›¾</button>
        <button class="adjust-btn" id="adjustBtn">âš« é‡æ–°é€‰æ‹©</button>
    </div>
    
    <div class="selection-overlay">
        <div class="selection-box" id="selectionBox">
            <div class="corner-handle top-left"></div>
            <div class="corner-handle top-right"></div>
            <div class="corner-handle bottom-left"></div>
            <div class="corner-handle bottom-right"></div>
        </div>
        <div class="selection-info" id="selectionInfo">
            0 Ã— 0
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let isSelecting = false;
        let isResizing = false;
        let resizeHandle = null;
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let currentY = 0;
        
        const selectionBox = document.getElementById('selectionBox');
        const selectionInfo = document.getElementById('selectionInfo');
        const instructions = document.getElementById('instructions');
        
        // é¼ æ ‡æŒ‰ä¸‹å¼€å§‹é€‰æ‹©æˆ–è°ƒæ•´
        document.addEventListener('mousedown', (e) => {
            if (e.button === 0) { // å·¦é”®
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è°ƒæ•´æ‰‹æŸ„
                if (e.target.classList.contains('corner-handle')) {
                    isResizing = true;
                    resizeHandle = e.target.classList[1]; // è·å–è§’è½ä½ç½® (top-left, top-right ç­‰)
                    e.stopPropagation();
                } else {
                    isSelecting = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    currentX = e.clientX;
                    currentY = e.clientY;

                    selectionBox.style.display = 'block';
                    selectionInfo.style.display = 'block';
                    instructions.style.display = 'none';

                    updateSelectionBox();
                }
            }
        });
        
        // é¼ æ ‡ç§»åŠ¨æ›´æ–°é€‰æ‹©æ¡†
        document.addEventListener('mousemove', (e) => {
            if (isSelecting) {
                currentX = e.clientX;
                currentY = e.clientY;
                updateSelectionBox();
            } else if (isResizing) {
                handleResize(e);
            }
        });

        // é¼ æ ‡é‡Šæ”¾æ˜¾ç¤ºç¡®è®¤æŒ‰é’®
        document.addEventListener('mouseup', (e) => {
            if ((isSelecting || isResizing) && e.button === 0) {
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                const wasResizing = isResizing;

                isSelecting = false;
                isResizing = false;
                resizeHandle = null;

                if (width > 5 && height > 5) {
                    if (e.shiftKey || wasResizing) {
                        showSelectionControls();
                    } else {
                        completeSelection();
                    }
                } else {
                    resetSelection();
                }
            }
        });

        // å¤„ç†è°ƒæ•´å¤§å°
        function handleResize(e) {
            const mouseX = e.clientX;
            const mouseY = e.clientY;

            switch (resizeHandle) {
                case 'top-left':
                    startX = mouseX;
                    startY = mouseY;
                    break;
                case 'top-right':
                    currentX = mouseX;
                    startY = mouseY;
                    break;
                case 'bottom-left':
                    startX = mouseX;
                    currentY = mouseY;
                    break;
                case 'bottom-right':
                    currentX = mouseX;
                    currentY = mouseY;
                    break;
            }

            updateSelectionBox();
        }

        // æ›´æ–°é€‰æ‹©æ¡†æ˜¾ç¤º
        function updateSelectionBox() {
            const left = Math.min(startX, currentX);
            const top = Math.min(startY, currentY);
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            
            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            
            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            selectionInfo.textContent = `${width} Ã— ${height}`;
            selectionInfo.style.left = (left + 10) + 'px';
            selectionInfo.style.top = (top + height + 10) + 'px';
        }
        
        // æ˜¾ç¤ºé€‰æ‹©æ§åˆ¶æŒ‰é’®
        function showSelectionControls() {
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);

            if (width > 10 && height > 10) {
                instructions.style.display = 'none';
                document.getElementById('selectionControls').style.display = 'flex';
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('fullscreenBtn').style.display = 'none';
            } else {
                resetSelection();
            }
        }

        // å®Œæˆé€‰æ‹©
        function completeSelection() {
            const left = Math.min(startX, currentX);
            const top = Math.min(startY, currentY);
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);

            const area = { x: left, y: top, width, height };

            // ç«‹å³éšè—æ‰€æœ‰UIå…ƒç´ ï¼Œé¿å…åœ¨æˆªå›¾ä¸­æ˜¾ç¤º
            hideAllUIElements();

            // å‘é€æˆªå›¾åŒºåŸŸä¿¡æ¯
            ipcRenderer.send('screenshot-area-selected', area);
        }

        // éšè—æ‰€æœ‰UIå…ƒç´ 
        function hideAllUIElements() {
            // éšè—æ‰€æœ‰æŒ‰é’®å’Œæ§ä»¶
            const elementsToHide = [
                'instructions',
                'cancelBtn',
                'fullscreenBtn',
                'selectionControls',
                'selectionBox',
                'selectionInfo'
            ];

            elementsToHide.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                }
            });

            // éšè—æ•´ä¸ªbodyï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰ä»»ä½•UIæ®‹ç•™
            document.body.style.opacity = '0';
        }

        // é‡æ–°é€‰æ‹©
        function resetSelection() {
            // éšè—é€‰æ‹©æ¡†å’Œä¿¡æ¯
            selectionBox.style.display = 'none';
            selectionInfo.style.display = 'none';
            document.getElementById('selectionControls').style.display = 'none';

            // æ˜¾ç¤ºè¯´æ˜æ–‡å­—å’Œå›ºå®šæŒ‰é’®
            instructions.style.display = 'block';
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('fullscreenBtn').style.display = 'block';

            // é‡ç½®çŠ¶æ€
            isSelecting = false;
            startX = 0;
            startY = 0;
            currentX = 0;
            currentY = 0;
        }
        
        // å–æ¶ˆé€‰æ‹©
        function cancelSelection() {
            ipcRenderer.send('screenshot-cancelled');
        }
        
        // å…¨å±æˆªå›¾
        function takeFullscreenShot() {
            const area = {
                x: 0,
                y: 0,
                width: window.screen.width,
                height: window.screen.height
            };

            // ç«‹å³éšè—æ‰€æœ‰UIå…ƒç´ 
            hideAllUIElements();

            ipcRenderer.send('screenshot-area-selected', area);
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('cancelBtn').addEventListener('click', cancelSelection);
        document.getElementById('fullscreenBtn').addEventListener('click', takeFullscreenShot);
        document.getElementById('confirmBtn').addEventListener('click', completeSelection);
        document.getElementById('adjustBtn').addEventListener('click', resetSelection);
        
        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cancelSelection();
            } else if (e.key === 'Enter') {
                takeFullscreenShot();
            }
        });
        
        // é˜»æ­¢å³é”®èœå•
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
        });
        
        // çª—å£å¤±å»ç„¦ç‚¹æ—¶ä¸ç«‹å³å–æ¶ˆé€‰æ‹©ï¼Œåªåœ¨ç”¨æˆ·æ˜ç¡®æ“ä½œæ—¶å–æ¶ˆ
        // è¿™æ ·å¯ä»¥é¿å…è¯¯è§¦å–æ¶ˆ
        /*
        window.addEventListener('blur', () => {
            if (isSelecting) {
                cancelSelection();
            }
        });
        */
        
        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºè¯´æ˜
        window.addEventListener('load', () => {
            setTimeout(() => {
                instructions.style.display = 'block';
            }, 100);
        });
    </script>
</body>
</html>